---
apiVersion: extensions.istio.io/v1alpha1
kind: WasmPlugin
metadata:
  name: sp-istio-agent
  namespace: istio-system
spec:
  url: http://host.docker.internal:8000/sp_istio_agent.wasm
  sha256: b7e3ca32d2c4cff4ace4cb1d8f7d07db7b0bc83e99fb209e952994b94697c7d3
  phase: AUTHN
  match:
    - mode: SERVER
    - mode: CLIENT
  pluginConfig:
    service_name: "demo-ota-111111"
    api_key: "demo-ota-01"
    sp_backend_url: "https://jaeger.softprobe.ai/"
    collectionRules:
      http:
        server:
          - path: ".*"
        client:
          - host: ".*"
            paths: [".*"]
  vmConfig:
    env:
      - name: ENVOY_LOG_LEVEL
        value: "debug"
      - name: WASM_LOG_LEVEL
        value: "debug"
---
apiVersion: networking.istio.io/v1beta1
kind: ServiceEntry
metadata:
  name: softprobe-backend
  namespace: istio-system
spec:
  hosts:
  - jaeger.softprobe.ai
  ports:
  - number: 443
    name: https
    protocol: HTTPS
  - number: 80
    name: http
    protocol: HTTP
  location: MESH_EXTERNAL
  resolution: DNS
---
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: softprobe-backend-tls
  namespace: istio-system
spec:
  host: jaeger.softprobe.ai
  trafficPolicy:
    tls:
      mode: SIMPLE
      sni: jaeger.softprobe.ai


