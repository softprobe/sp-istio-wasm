---
# Softprobe Istio Agent - Test Configuration for Bookinfo App
# This configuration targets only the productpage service for testing
# Usage: kubectl apply -f deploy/test-bookinfo.yaml

apiVersion: extensions.istio.io/v1alpha1
kind: WasmPlugin
metadata:
  name: sp-istio-agent-test
  namespace: default  # Apply to default namespace where Bookinfo is running
spec:
  # Apply only to productpage service to test outbound calls
  selector:
    matchLabels:
      app: productpage
  
  # Remove mode restriction to test if CLIENT mode blocks response callbacks
  # match:
  #   - mode: CLIENT  # Test without this restriction
  
  # Use the public Docker Hub image (which contains the WASM binary)
  url: oci://docker.io/softprobe/sp-istio-wasm:v1.0.13-https
  sha256: "736b2c574ea820ebfe6e1b134e35c32b5fe534c98c2e24e8da468f86086f48fb"
  phase: AUTHN  # Insert early for header injection and request control
  
  # Configuration for the WASM extension
  pluginConfig:
    # Backend Configuration
    sp_backend_url: "https://o.softprobe.ai"
    enable_inject: false  
    traffic_direction: "outbound"  # Back to outbound for real testing
    service_name: "productpage-test"  # Service name for tracking
    api_key: ""  # Empty API key for testing
    
    # Collection Rules - capture outbound traffic from productpage  
    collectionRules:
      http:
        server: []  # No server-side filtering
        client:     # Client-side rules for outbound traffic
          - host: ".*"        # Match all hosts
            paths: [".*"]     # Match all paths

---
# ServiceEntry to register Softprobe backend as external service
# This creates an upstream cluster that WASM can reference in dispatch_http_call
apiVersion: networking.istio.io/v1beta1
kind: ServiceEntry
metadata:
  name: softprobe-backend
  namespace: default
spec:
  hosts:
  - o.softprobe.ai
  ports:
  - number: 443
    name: https
    protocol: HTTPS
  location: MESH_EXTERNAL
  resolution: DNS