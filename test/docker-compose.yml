version: '3.8'

services:
  demo-ota:
    image: gcr.io/cs-poc-sasxbttlzroculpau4u6e2l/demo-ota:v1.2.1
    networks:
      - service-network
      - otel-network
    environment:
      # 显式配置代理 
      - HTTP_PROXY=http://envoy-dict-app:15001
      - HTTPS_PROXY=http://envoy-dict-app:15001
      - http_proxy=http://envoy-dict-app:15001
      - https_proxy=http://envoy-dict-app:15001
      - OTEL_EXPORTER_OTLP_ENDPOINT=https://jaeger.softprobe.ai
    ports:
      - "8080:8080"
  demo-airline:
    image: gcr.io/cs-poc-sasxbttlzroculpau4u6e2l/demo-airline:v0.0.3
    networks:
      - service-network
      - otel-network
    ports:
      - "8081:8081"
    environment:
      # 显式配置代理 
      - HTTP_PROXY=http://envoy-dict-app:15001
      - HTTPS_PROXY=http://envoy-dict-app:15001
      - http_proxy=http://envoy-dict-app:15001
      - https_proxy=http://envoy-dict-app:15001
      - OTEL_EXPORTER_OTLP_ENDPOINT=https://jaeger.softprobe.ai

  envoy-dict-app:
    image: envoyproxy/envoy:v1.27-latest
    command: ["/usr/local/bin/envoy", "-c", "/etc/envoy/envoy.yaml", "--log-level", "info"]
    volumes:
      - ./envoy.yaml:/etc/envoy/envoy.yaml
      - ../target/wasm32-unknown-unknown/release/sp_istio_agent.wasm:/etc/envoy/sp_istio_agent.wasm
    networks:
      - service-network
      - otel-network
    ports:
      - "15001:15001" # 出站流量
      - "15006:15006" # 入站流量


networks:
  service-network:
    driver: bridge
  otel-network:
    driver: bridge
